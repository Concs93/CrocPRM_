//============================================================
// Visual Drop Global System - Sistema Global de Drop Visual
// - Monitora kills de NPCs
// - Verifica itens equipados com flag de drop
// - Drop único por conta (não repete)
//============================================================
-	script	VisualDropGlobal	-1,{

	// ---------- CONFIG ----------
	OnInit:
		// Array de itens que dão drop visual (45 itens)
		setarray .drop_items[0], 2742, 2841, 2863, 4335, 4664, 5165, 7385, 13078, 13671, 13695, 15401, 16147, 19095, 19117, 19118, 19143, 19146, 19147, 19148, 19149, 19150, 19151, 19152, 19153, 19154, 19157, 20174, 20802, 20803, 20804, 20805, 20806, 20807, 20808, 20809, 20811, 20822, 24007, 24224, 24504, 24505, 24506, 24507, 30105, 30108;

		// Arrays de costumes divididos em blocos (471 costumes total)
		// Bloco 1: IDs 5157-19764
		setarray .costume_ids_1[0], 5157, 5224, 5909, 5979, 14677, 14678, 14679, 18740, 18741, 18742, 18744, 19424, 19433, 19459, 19466, 19524, 19525, 19526, 19527, 19528, 19529, 19530, 19531, 19532, 19533, 19534, 19535, 19536, 19537, 19539, 19540, 19541, 19542, 19544, 19545, 19546, 19547, 19548, 19549, 19550, 19551, 19552, 19553, 19554, 19555, 19556, 19557, 19558, 19559, 19560, 19561, 19562, 19563, 19564, 19565, 19566, 19567, 19568, 19569, 19570, 19571, 19572, 19573, 19576, 19579, 19581, 19586, 19587, 19588, 19598, 19599, 19619, 19627, 19628, 19630, 19632, 19645, 19650, 19666, 19669, 19676, 19683, 19686, 19692, 19702, 19704, 19707, 19710, 19711, 19731, 19733, 19734, 19736, 19737, 19739, 19742, 19750, 19758, 19759, 19764;
		// Bloco 2: IDs 19765-20421
		setarray .costume_ids_2[0], 19765, 19775, 19779, 19780, 19804, 19809, 19827, 19831, 19835, 19839, 19849, 19853, 19856, 19862, 19863, 19871, 19875, 19881, 19882, 19903, 19910, 19911, 19917, 19918, 19919, 19920, 19927, 19947, 19951, 19976, 19982, 19990, 20000, 20001, 20002, 20003, 20004, 20011, 20025, 20026, 20027, 20028, 20033, 20043, 20053, 20060, 20063, 20064, 20067, 20068, 20086, 20087, 20088, 20089, 20099, 20110, 20111, 20126, 20132, 20136, 20139, 20140, 20154, 20162, 20163, 20164, 20165, 20168, 20174, 20179, 20183, 20185, 20206, 20209, 20210, 20211, 20220, 20227, 20228, 20234, 20237, 20246, 20264, 20278, 20304, 20323, 20371, 20379, 20388, 20397, 20403, 20404, 20407, 20409, 20416, 20417, 20418, 20419, 20420, 20421;
		// Bloco 3: IDs 20422-25183
		setarray .costume_ids_3[0], 20422, 20423, 20424, 20435, 20440, 20450, 20451, 20457, 20459, 20472, 20473, 20487, 21202, 21206, 21207, 21300, 23723, 25101, 25102, 25103, 25104, 25105, 25106, 25107, 25108, 25109, 25110, 25111, 25112, 25113, 25114, 25115, 25116, 25117, 25118, 25119, 25120, 25121, 25122, 25123, 25124, 25125, 25126, 25127, 25128, 25129, 25130, 25131, 25132, 25133, 25134, 25135, 25136, 25137, 25138, 25139, 25140, 25141, 25142, 25143, 25144, 25145, 25146, 25147, 25148, 25149, 25150, 25151, 25152, 25153, 25154, 25155, 25156, 25157, 25158, 25159, 25160, 25161, 25162, 25163, 25164, 25165, 25166, 25167, 25168, 25169, 25170, 25171, 25172, 25173, 25174, 25175, 25176, 25177, 25178, 25179, 25180, 25181, 25182, 25183;
		// Bloco 4: IDs 25184-31772
		setarray .costume_ids_4[0], 25184, 25185, 25186, 25187, 25188, 25189, 25190, 29982, 29983, 29984, 29985, 29986, 29987, 29988, 29989, 29990, 29991, 29992, 29993, 29994, 29995, 29996, 29997, 29998, 29999, 31033, 31034, 31040, 31047, 31089, 31091, 31105, 31125, 31140, 31141, 31142, 31143, 31150, 31157, 31160, 31195, 31205, 31259, 31262, 31263, 31308, 31311, 31316, 31319, 31320, 31325, 31375, 31388, 31391, 31398, 31410, 31416, 31461, 31479, 31482, 31488, 31490, 31497, 31530, 31542, 31551, 31577, 31583, 31586, 31588, 31602, 31611, 31614, 31617, 31618, 31620, 31645, 31646, 31647, 31648, 31649, 31650, 31651, 31652, 31653, 31654, 31655, 31656, 31657, 31658, 31659, 31660, 31706, 31721, 31728, 31766, 31769, 31770, 31771, 31772;
		// Bloco 5: IDs 31773-440006
		setarray .costume_ids_5[0], 31773, 31774, 31775, 31776, 31777, 31844, 31845, 31846, 31848, 31849, 31850, 31851, 31853, 31856, 31857, 31858, 31859, 31860, 31861, 31862, 31863, 31864, 31865, 31866, 31867, 31868, 31869, 31870, 31871, 31886, 31905, 31906, 31907, 31911, 31916, 31922, 31923, 31927, 31930, 31931, 31932, 31933, 31934, 31936, 31937, 31938, 31943, 31944, 31946, 400055, 400074, 400076, 400115, 400124, 400148, 410005, 410056, 410062, 420010, 420025, 420095, 420096, 420097, 420098, 420099, 420100, 420101, 420102, 440002, 440003, 440006;

		// Total de costumes
		.total_costumes = 471;

		// bind dos comandos
		bindatcmd "resetcostumes", strnpcinfo(3)+"::OnResetDrops";
		bindatcmd "viewcostumes", strnpcinfo(3)+"::OnViewCostumes";

		end;

	// ---------- EVENTO DE KILL ----------
	OnNPCKillEvent:
		// Contar quantos itens elegíveis estão equipados
		.@equipped_count = 0;

		for (.@i = 0; .@i < getarraysize(.drop_items); .@i++) {
			.@item_id = .drop_items[.@i];
			.@is_equipped = 0;
			.@is_card = 0;
			
			// Verificar equipamentos (itens equipados)
			if (getequipid(EQI_HEAD_TOP) == .@item_id ||
				getequipid(EQI_HEAD_MID) == .@item_id ||
				getequipid(EQI_HEAD_LOW) == .@item_id ||
				getequipid(EQI_ARMOR) == .@item_id   ||
				getequipid(EQI_SHOES) == .@item_id   ||
				getequipid(EQI_ACCESSORY) == .@item_id ||
				getequipid(EQI_ACCESSORY2) == .@item_id) {
				.@is_equipped = 1;
			}
			
			// Verificar cartas nos equipamentos (todos os slots)
			if (getequipcardid(EQI_HEAD_TOP, 0) == .@item_id || getequipcardid(EQI_HEAD_TOP, 1) == .@item_id || getequipcardid(EQI_HEAD_TOP, 2) == .@item_id || getequipcardid(EQI_HEAD_TOP, 3) == .@item_id ||
				getequipcardid(EQI_HEAD_MID, 0) == .@item_id || getequipcardid(EQI_HEAD_MID, 1) == .@item_id || getequipcardid(EQI_HEAD_MID, 2) == .@item_id || getequipcardid(EQI_HEAD_MID, 3) == .@item_id ||
				getequipcardid(EQI_HEAD_LOW, 0) == .@item_id || getequipcardid(EQI_HEAD_LOW, 1) == .@item_id || getequipcardid(EQI_HEAD_LOW, 2) == .@item_id || getequipcardid(EQI_HEAD_LOW, 3) == .@item_id ||
				getequipcardid(EQI_ARMOR, 0) == .@item_id || getequipcardid(EQI_ARMOR, 1) == .@item_id || getequipcardid(EQI_ARMOR, 2) == .@item_id || getequipcardid(EQI_ARMOR, 3) == .@item_id ||
				getequipcardid(EQI_SHOES, 0) == .@item_id || getequipcardid(EQI_SHOES, 1) == .@item_id || getequipcardid(EQI_SHOES, 2) == .@item_id || getequipcardid(EQI_SHOES, 3) == .@item_id ||
				getequipcardid(EQI_ACCESSORY, 0) == .@item_id || getequipcardid(EQI_ACCESSORY, 1) == .@item_id || getequipcardid(EQI_ACCESSORY, 2) == .@item_id || getequipcardid(EQI_ACCESSORY, 3) == .@item_id ||
				getequipcardid(EQI_ACCESSORY2, 0) == .@item_id || getequipcardid(EQI_ACCESSORY2, 1) == .@item_id || getequipcardid(EQI_ACCESSORY2, 2) == .@item_id || getequipcardid(EQI_ACCESSORY2, 3) == .@item_id) {
				.@is_card = 1;
			}
			
			// Contar se encontrou
			if (.@is_equipped || .@is_card) {
				.@equipped_count++;
			}
		}

		if (.@equipped_count == 0) {
			end;
		}
		
		// Chance: 0.1% por item
		.@chance = .@equipped_count * 10; // em /10000
		
		// Crown_ (5165) força 100%
		// if (getequipid(EQI_HEAD_TOP) == 5165) {
		// 	.@chance = 10000;
		// }
		
		if (rand(10000) >= .@chance) {
			end;
		}

		callsub(OnDropCostume);
		end;

	// ---------- FUNÇÃO DE DROP ----------
	OnDropCostume:
		// Tamanho atual da coleção da conta
		.@have = getarraysize(#costumes_dropped);

		// Se completou tudo, limpa e recomeça
		if (.@have >= .total_costumes) {
			deletearray #costumes_dropped[0], .@have;
			.@have = 0;
			dispbottom("Você completou a coleção de costumes! Lista foi resetada.");
		}

		// Escolher um costume que ainda não foi dropado
		do {
			.@block = rand(5) + 1;

			switch (.@block) {
				case 1: .@random_index = rand(getarraysize(.costume_ids_1)); .@costume_id = .costume_ids_1[.@random_index]; break;
				case 2: .@random_index = rand(getarraysize(.costume_ids_2)); .@costume_id = .costume_ids_2[.@random_index]; break;
				case 3: .@random_index = rand(getarraysize(.costume_ids_3)); .@costume_id = .costume_ids_3[.@random_index]; break;
				case 4: .@random_index = rand(getarraysize(.costume_ids_4)); .@costume_id = .costume_ids_4[.@random_index]; break;
				default: .@random_index = rand(getarraysize(.costume_ids_5)); .@costume_id = .costume_ids_5[.@random_index]; break;
			}
		} while (inarray(#costumes_dropped, .@costume_id) != -1);

		// Armazena no array da CONTA e entrega
		#costumes_dropped[.@have] = .@costume_id;
		getitem .@costume_id, 1;

		dispbottom("Você recebeu um costume especial! (" + (.@have + 1) + "/" + .total_costumes + ")");
		return;
}